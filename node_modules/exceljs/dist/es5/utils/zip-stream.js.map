{"version":3,"sources":["../../../lib/utils/zip-stream.js"],"names":["events","require","PromishLib","JSZip","utils","StreamBuf","ZipReader","options","count","jsZip","stream","on","_process","getEntryType","inherits","EventEmitter","_finished","Promish","resolve","then","emit","content","read","loadAsync","zip","forEach","path","entry","dir","async","entryStream","write","data","autodrain","catch","error","encoding","callback","cork","uncork","end","destroy","ZipWriter","append","hasOwnProperty","base64","file","name","finalize","type","compression","generateAsync","size","setEncoding","pause","resume","isPaused","pipe","destination","unpipe","unshift","chunk","wrap","module","exports"],"mappings":"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","file":"zip-stream.js","sourcesContent":["/**\r\n * Copyright (c) 2016-2017 Guyon Roche\r\n * LICENCE: MIT - please refer to LICENCE file included with this module\r\n * or https://github.com/guyonroche/exceljs/blob/master/LICENSE\r\n */\r\n\r\n'use strict';\r\n\r\n// The purpose of this module is to wrap the js-zip library into a streaming zip library\r\n// since most of the exceljs code uses streams.\r\n// One day I might find (or build) a properly streaming browser safe zip lib\r\n\r\nvar events = require('events');\r\nvar PromishLib = require('./promish');\r\n\r\nvar JSZip = require('jszip');\r\n\r\nvar utils = require('./utils');\r\nvar StreamBuf = require('./stream-buf');\r\n\r\n\r\n// =============================================================================\r\n// The ZipReader class\r\n// Unpacks an incoming zip stream\r\nvar ZipReader = function(options) {\r\n  this.count = 0;\r\n  this.jsZip = new JSZip();\r\n  this.stream = new StreamBuf();\r\n  this.stream.on('finish', () => {\r\n    this._process();\r\n  });\r\n  this.getEntryType = options.getEntryType || (() => 'string');\r\n};\r\n\r\nutils.inherits(ZipReader, events.EventEmitter, {\r\n  _finished: function() {\r\n    if (!--this.count) {\r\n      PromishLib.Promish.resolve()\r\n        .then(() => {\r\n          this.emit('finished');\r\n        });\r\n    }\r\n  },\r\n  _process: function() {\r\n    var content = this.stream.read();\r\n    this.jsZip.loadAsync(content)\r\n      .then(zip => {\r\n        zip.forEach((path, entry) => {\r\n          if (!entry.dir) {\r\n            this.count++;\r\n            entry.async(this.getEntryType(path))\r\n              .then(data => {\r\n                var entryStream = new StreamBuf();\r\n                entryStream.path = path;\r\n                entryStream.write(data);\r\n                entryStream.autodrain = () => {\r\n                  this._finished();\r\n                };\r\n                entryStream.on('finish', () => {\r\n                  this._finished();\r\n                });\r\n\r\n                this.emit('entry', entryStream);\r\n              })\r\n              .catch(error => {\r\n                this.emit('error', error);\r\n              });\r\n          }\r\n        });\r\n      })\r\n      .catch(error => {\r\n        this.emit('error', error);\r\n      });\r\n  },\r\n\r\n  // ==========================================================================\r\n  // Stream.Writable interface\r\n  write: function(data, encoding, callback) {\r\n    if (this.error) {\r\n      if (callback) {\r\n        callback(error);\r\n      }\r\n      throw error;\r\n    } else {\r\n      return this.stream.write(data, encoding, callback);\r\n    }\r\n  },\r\n  cork: function() {\r\n    return this.stream.cork();\r\n  },\r\n  uncork: function() {\r\n    return this.stream.uncork();\r\n  },\r\n  end: function() {\r\n    return this.stream.end();\r\n  },\r\n  destroy: function(error) {\r\n    this.emit('finished');\r\n    this.error = error;\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n// The ZipWriter class\r\n// Packs streamed data into an output zip stream\r\nvar ZipWriter = function() {\r\n  this.zip = new JSZip();\r\n  this.stream = new StreamBuf();\r\n};\r\n\r\nutils.inherits(ZipWriter, events.EventEmitter, {\r\n\r\n  append: function(data, options) {\r\n    if (options.hasOwnProperty('base64') && options.base64) {\r\n      this.zip.file(options.name, data, { base64: true });\r\n    } else {\r\n      this.zip.file(options.name, data);\r\n    }\r\n  },\r\n  finalize: function() {\r\n    var options = {\r\n      type: 'nodebuffer',\r\n      compression: 'DEFLATE'\r\n    };\r\n    return this.zip.generateAsync(options)\r\n      .then(content => {\r\n        this.stream.end(content);\r\n        this.emit('finish');\r\n      });\r\n  },\r\n\r\n  // ==========================================================================\r\n  // Stream.Readable interface\r\n  read: function(size) {\r\n    return this.stream.read(size);\r\n  },\r\n  setEncoding: function(encoding) {\r\n    return this.stream.setEncoding(encoding);\r\n  },\r\n  pause: function() {\r\n    return this.stream.pause();\r\n  },\r\n  resume: function() {\r\n    return this.stream.resume();\r\n  },\r\n  isPaused: function() {\r\n    return this.stream.isPaused();\r\n  },\r\n  pipe: function(destination, options) {\r\n    return this.stream.pipe(destination, options);\r\n  },\r\n  unpipe: function(destination) {\r\n    return this.stream.unpipe(destination);\r\n  },\r\n  unshift: function(chunk) {\r\n    return this.stream.unshift(chunk);\r\n  },\r\n  wrap: function(stream) {\r\n    return this.stream.wrap(stream);\r\n  }\r\n});\r\n\r\n// =============================================================================\r\n\r\nmodule.exports = {\r\n  ZipReader: ZipReader,\r\n  ZipWriter: ZipWriter\r\n};\r\n"]}